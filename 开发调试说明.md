# 开发调试说明

## "打开文件夹失败" 问题排查

### 问题原因
1. **未在Electron环境中运行**
   - 如果使用 `npm run dev`，需要确保Electron窗口已启动
   - 浏览器中访问 http://localhost:5173 无法使用文件系统API

2. **Electron API未加载**
   - preload脚本未正确执行
   - contextBridge配置问题

### 解决方法

#### 方法1：正确启动开发环境

```bash
# 确保使用正确的启动命令
npm run dev
```

这会同时启动：
- Vite开发服务器
- Electron应用窗口

**不要**直接在浏览器中打开 http://localhost:5173

#### 方法2：检查控制台

打开开发者工具（Electron窗口中按F12），检查：

```javascript
// 在控制台输入，检查API是否存在
console.log(window.electronAPI);

// 应该显示对象，包含所有方法
// 如果显示 undefined，说明API未加载
```

#### 方法3：验证selectFolder API

```javascript
// 在控制台测试
window.electronAPI?.selectFolder?.()
  .then(folder => console.log('选中的文件夹:', folder))
  .catch(err => console.error('错误:', err));
```

### 常见错误

#### 错误1: `window.electronAPI is undefined`

**原因**: 
- 在浏览器中打开
- preload脚本未执行

**解决**:
```bash
# 停止当前进程
Ctrl + C

# 重新启动
npm run dev
```

#### 错误2: `selectFolder is not a function`

**原因**: 
- electron/preload.ts 未正确编译
- IPC handler 未注册

**解决**:
```bash
# 清理并重新构建
npm run clean
npm run dev
```

#### 错误3: "打开文件夹失败"

**原因**:
- 权限问题
- 路径不存在

**解决**:
- 以管理员身份运行（Windows）
- 检查选择的路径权限

### 调试步骤

1. **确认Electron窗口已打开**
   ```
   ✓ 看到窗口标题 "SuperTools"
   ✓ 窗口大小 1400x900
   ✓ 显示欢迎页面
   ```

2. **打开开发者工具**
   ```
   按 F12 或 Ctrl+Shift+I
   ```

3. **检查API状态**
   ```javascript
   // 控制台执行
   console.table({
     'API存在': !!window.electronAPI,
     'selectFolder': typeof window.electronAPI?.selectFolder,
     'getAppVersion': typeof window.electronAPI?.getAppVersion
   });
   ```

4. **手动测试选择文件夹**
   ```javascript
   // 控制台执行
   async function testSelectFolder() {
     try {
       const folder = await window.electronAPI.selectFolder();
       console.log('✓ 成功:', folder);
       return folder;
     } catch (error) {
       console.error('✗ 失败:', error);
       throw error;
     }
   }
   
   testSelectFolder();
   ```

### 预期结果

**正确启动后应该看到:**

```
控制台输出:
✓ Vite v5.0.8  ready in XXX ms
✓ Local:   http://localhost:5173/
✓ Electron app started

Electron窗口显示:
┌─────────────────────────────────────┐
│ SuperTools  [📁 打开文件夹]        │
├─────────────────────────────────────┤
│                                     │
│     欢迎使用 SuperTools              │
│     打开一个文件夹开始使用           │
│     [📁 打开文件夹]                 │
│                                     │
└─────────────────────────────────────┘
```

### 如果问题仍然存在

1. **完全重新安装**
```bash
# 删除依赖
rm -rf node_modules
rm package-lock.json

# 重新安装
npm install

# 启动
npm run dev
```

2. **检查 electron/main.ts**
确保包含:
```typescript
import { registerIpcHandlers } from './ipc-handlers.js';

app.whenReady().then(() => {
  registerIpcHandlers(); // 重要！
  createWindow();
});
```

3. **检查 electron/preload.ts**
确保包含:
```typescript
selectFolder: () => ipcRenderer.invoke('select-folder')
```

4. **检查 electron/ipc-handlers.ts**
确保包含:
```typescript
ipcMain.handle('select-folder', async (): Promise<string | null> => {
  // ...实现代码
});
```

---

## 快速测试清单

- [ ] 使用 `npm run dev` 启动（不是浏览器访问）
- [ ] Electron窗口已打开
- [ ] F12打开开发者工具
- [ ] 控制台无红色错误
- [ ] `window.electronAPI` 存在
- [ ] `window.electronAPI.selectFolder` 是函数
- [ ] 点击"打开文件夹"按钮
- [ ] 出现系统文件选择对话框
- [ ] 选择文件夹后显示成功消息

---

**如果以上都检查过仍有问题，请提供：**
1. 控制台完整错误信息
2. `console.log(window.electronAPI)` 的输出
3. 使用的启动命令


